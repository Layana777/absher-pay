# ๐ Firebase Security Rules Setup

## ๐ ูุธุฑุฉ ุนุงูุฉ

ูุฐุง ุงูููู ูุดุฑุญ ููููุฉ ุชุทุจูู ููุงุนุฏ ุงูุฃูุงู ูู Firebase Realtime Database ูุญูุงูุฉ ุจูุงูุงุช ุงูุจุทุงูุงุช ูุงูุญุณุงุจุงุช ุงูุจูููุฉ.

---

## ๐ ููููุฉ ุชุทุจูู ุงูููุงุนุฏ

### ุงูุทุฑููุฉ 1: ุนุจุฑ Firebase Console (ููุตู ุจูุง)

1. **ุงุฐูุจ ุฅูู Firebase Console**:
   - ุงูุชุญ [Firebase Console](https://console.firebase.google.com/)
   - ุงุฎุชุฑ ูุดุฑูุนู: `absher-pay`

2. **ุงุฐูุจ ุฅูู Realtime Database**:
   - ูู ุงููุงุฆูุฉ ุงูุฌุงูุจูุฉ โ `Realtime Database`
   - ุงุฎุชุฑ ุชุจููุจ `Rules`

3. **ุงูุณุฎ ุงูููุงุนุฏ**:
   - ุงูุชุญ ููู [firebase-rules.json](./firebase-rules.json)
   - ุงูุณุฎ ุงููุญุชูู ูุงููุงู

4. **ุงูุตู ุงูููุงุนุฏ ูู Firebase**:
   - ุงูุตู ุงููุญุชูู ูู ูุญุฑุฑ ุงูููุงุนุฏ
   - ุงุถุบุท `Publish`

5. **ุงูุชุฃูุฏ ูู ุงููุดุฑ**:
   - ุณุชุธูุฑ ุฑุณุงูุฉ: "Rules published successfully"
   - ุชุงุฑูุฎ ุขุฎุฑ ุชุนุฏูู ุณูุชู ุชุญุฏูุซู

---

### ุงูุทุฑููุฉ 2: ุนุจุฑ Firebase CLI

```bash
# 1. ุชุซุจูุช Firebase CLI (ุฅุฐุง ูู ููู ูุซุจุช)
npm install -g firebase-tools

# 2. ุชุณุฌูู ุงูุฏุฎูู
firebase login

# 3. ุชููุฆุฉ ุงููุดุฑูุน (ุฅุฐุง ูู ููู ูููุฃ)
firebase init database

# 4. ูุดุฑ ุงูููุงุนุฏ
firebase deploy --only database
```

---

## ๐ ุดุฑุญ ุงูููุงุนุฏ

### 1. ููุงุนุฏ ุงูุจุทุงูุงุช (Cards)

```json
"cards": {
  ".read": "auth != null && auth.uid == $uid",
  ".write": "auth != null && auth.uid == $uid"
}
```

**ุงูุดุฑุญ**:
- โ **ุงููุฑุงุกุฉ**: ุงููุณุชุฎุฏู ููููู ููุท ูุฑุงุกุฉ ุจุทุงูุงุชู ุงูุฎุงุตุฉ
- โ **ุงููุชุงุจุฉ**: ุงููุณุชุฎุฏู ููููู ููุท ุฅุถุงูุฉ/ุชุนุฏูู/ุญุฐู ุจุทุงูุงุชู ุงูุฎุงุตุฉ
- โ **ูุง ูููู**: ุงููุตูู ูุจุทุงูุงุช ุงููุณุชุฎุฏููู ุงูุขุฎุฑูู

---

### 2. ุงูุชุญูู ูู ุงูุจูุงูุงุช (Validation)

#### ุฃ) ุฑูู ุงูุจุทุงูุฉ (cardNumber):

```json
"cardNumber": {
  ".validate": "newData.isString() && newData.val().length == 4"
}
```

**ุงูุดุฑุญ**:
- โ ูุฌุจ ุฃู ูููู ูุต (string)
- โ ูุฌุจ ุฃู ูููู 4 ุฃุญุฑู ููุท (ุขุฎุฑ 4 ุฃุฑูุงู)
- โ ูุง ููุจู ุฑูู ุงูุจุทุงูุฉ ุงููุงูู (16 ุฑูู)

**ูุซุงู ุตุญูุญ**: `"9012"`
**ูุซุงู ุฎุงุทุฆ**: `"1234567890123456"`

---

#### ุจ) ููุน ุงูุจุทุงูุฉ (cardType):

```json
"cardType": {
  ".validate": "newData.isString() && (newData.val() == 'mada' || newData.val() == 'visa' || newData.val() == 'mastercard' || newData.val() == 'amex')"
}
```

**ุงูุดุฑุญ**:
- โ ููุจู ููุท: `mada`, `visa`, `mastercard`, `amex`
- โ ูุง ููุจู ุฃู ูููุฉ ุฃุฎุฑู

---

#### ุฌ) ุชุงุฑูุฎ ุงูุงูุชูุงุก (expiryDate):

```json
"expiryDate": {
  ".validate": "newData.isString() && newData.val().matches(/^(0[1-9]|1[0-2])\\/[0-9]{2}$/)"
}
```

**ุงูุดุฑุญ**:
- โ ูุฌุจ ุฃู ูููู ุจุตูุบุฉ: `MM/YY`
- โ ุงูุดูุฑ: 01-12 ููุท
- โ ุงูุณูุฉ: ุฑูููู ููุท

**ูุซุงู ุตุญูุญ**: `"12/25"`, `"01/30"`
**ูุซุงู ุฎุงุทุฆ**: `"13/25"`, `"12/2025"`, `"1/25"`

---

#### ุฏ) ูุนุฑู ุงููุณุชุฎุฏู (userId):

```json
"userId": {
  ".validate": "newData.isString() && newData.val() == $uid"
}
```

**ุงูุดุฑุญ**:
- โ ูุฌุจ ุฃู ูููู ูุนุฑู ุงููุณุชุฎุฏู ุงูุญุงูู
- โ ูุง ูููู ุญูุธ ุจุทุงูุฉ ุจุงุณู ูุณุชุฎุฏู ุขุฎุฑ

---

### 3. ุงูุญููู ุงููุทููุจุฉ

```json
".validate": "newData.hasChildren(['id', 'userId', 'cardNumber', 'bankName', 'cardType', 'type', 'createdAt', 'updatedAt'])"
```

**ุงูุญููู ุงููุทููุจุฉ**:
- โ `id` - ูุนุฑู ุงูุจุทุงูุฉ
- โ `userId` - ูุนุฑู ุงููุณุชุฎุฏู
- โ `cardNumber` - ุขุฎุฑ 4 ุฃุฑูุงู
- โ `bankName` - ุงุณู ุงูุจูู
- โ `cardType` - ููุน ุงูุจุทุงูุฉ (mada/visa/...)
- โ `type` - ุงูููุน ุจุงูุนุฑุจูุฉ
- โ `createdAt` - ุชุงุฑูุฎ ุงูุฅูุดุงุก
- โ `updatedAt` - ุชุงุฑูุฎ ุงูุชุญุฏูุซ

**ุงูุญููู ุงูุงุฎุชูุงุฑูุฉ**:
- โช `holderName` - ุงุณู ุญุงูู ุงูุจุทุงูุฉ
- โช `expiryDate` - ุชุงุฑูุฎ ุงูุงูุชูุงุก
- โช `isDefault` - ุงูุจุทุงูุฉ ุงูุงูุชุฑุงุถูุฉ

---

### 4. ููุน ุงูุญููู ุงูุฅุถุงููุฉ

```json
"$other": {
  ".validate": false
}
```

**ุงูุดุฑุญ**:
- โ ูุง ูููู ุฅุถุงูุฉ ุญููู ุบูุฑ ูุญุฏุฏุฉ ูู ุงูููุงุนุฏ
- โ ูุซูุงู: `cvv`, `pin`, `fullCardNumber`

**ููุงุฐุงุ**
- ูููุน ุญูุธ ุจูุงูุงุช ุญุณุงุณุฉ ุจุงูุฎุทุฃ
- ูุถูุงู ุจููุฉ ุจูุงูุงุช ููุญุฏุฉ

---

## ๐งช ุงุฎุชุจุงุฑ ุงูููุงุนุฏ

### Test Case 1: ุญูุธ ุจุทุงูุฉ ุตุญูุญุฉ โ

```javascript
const cardData = {
  id: "-NxYz123",
  userId: "business_1234567890",
  cardNumber: "9012",          // โ 4 ุฃุฑูุงู ููุท
  bankName: "ูุตุฑู ุงูุฑุงุฌุญู",
  cardType: "mada",             // โ ูููุฉ ุตุญูุญุฉ
  type: "ูุฏู",
  holderName: "ุฃุญูุฏ ูุญูุฏ",
  expiryDate: "12/25",          // โ ุตูุบุฉ ุตุญูุญุฉ
  isDefault: false,
  createdAt: 1701234567890,
  updatedAt: 1701234567890
};

await saveCard(uid, cardData);
// ุงููุชูุฌุฉ: โ ูุฌุญ
```

---

### Test Case 2: ุญูุธ ุจุทุงูุฉ ุจุฑูู ูุงูู โ

```javascript
const cardData = {
  id: "-NxYz123",
  userId: "business_1234567890",
  cardNumber: "1234567890123456", // โ 16 ุฑูู
  bankName: "ูุตุฑู ุงูุฑุงุฌุญู",
  cardType: "mada",
  type: "ูุฏู",
  createdAt: 1701234567890,
  updatedAt: 1701234567890
};

await saveCard(uid, cardData);
// ุงููุชูุฌุฉ: โ ูุดู - cardNumber ูุฌุจ ุฃู ูููู 4 ุฃุญุฑู ููุท
```

---

### Test Case 3: ุญูุธ ุจุทุงูุฉ ูุน CVV โ

```javascript
const cardData = {
  id: "-NxYz123",
  userId: "business_1234567890",
  cardNumber: "9012",
  bankName: "ูุตุฑู ุงูุฑุงุฌุญู",
  cardType: "mada",
  type: "ูุฏู",
  cvv: "123",                    // โ ุญูู ุบูุฑ ูุณููุญ
  createdAt: 1701234567890,
  updatedAt: 1701234567890
};

await saveCard(uid, cardData);
// ุงููุชูุฌุฉ: โ ูุดู - cvv ุญูู ุบูุฑ ูุณููุญ
```

---

### Test Case 4: ูุฑุงุกุฉ ุจุทุงูุงุช ูุณุชุฎุฏู ุขุฎุฑ โ

```javascript
// ุงููุณุชุฎุฏู A ูุญุงูู ูุฑุงุกุฉ ุจุทุงูุงุช ุงููุณุชุฎุฏู B
const userA_uid = "business_1111111111";
const userB_uid = "business_2222222222";

// ุชุณุฌูู ุฏุฎูู ุงููุณุชุฎุฏู A
await signIn(userA_uid);

// ูุญุงููุฉ ูุฑุงุกุฉ ุจุทุงูุงุช ุงููุณุชุฎุฏู B
await getUserCards(userB_uid);
// ุงููุชูุฌุฉ: โ ูุดู - permission denied
```

---

## ๐ ุงูุชุญูู ูู ุงูููุงุนุฏ ูู Console

ุจุนุฏ ุชุทุจูู ุงูููุงุนุฏุ ููููู ุงูุชุญูู ูููุง:

### 1. ูู Firebase Console:

1. ุงุฐูุจ ุฅูู `Realtime Database` โ `Rules`
2. ุณุชุฌุฏ ุงูููุงุนุฏ ุงููุทุจูุฉ
3. ุชุญูู ูู ุชุงุฑูุฎ ุขุฎุฑ ูุดุฑ

### 2. ูุญุงูุงุฉ ุงููุฑุงุกุฉ/ุงููุชุงุจุฉ:

ูู Firebase Console โ Realtime Database โ Rules:

1. ุงุถุบุท ุนูู `Simulator`
2. ุงุฎุชุฑ ููุน ุงูุนูููุฉ: `Read` ุฃู `Write`
3. ุฃุฏุฎู ุงููุณุงุฑ: `users/business_1234567890/cards/-NxYz123`
4. ุงุฎุชุฑ `Authenticated` ูุฃุฏุฎู UID
5. ุงุถุบุท `Run`

**ูุซุงู**:
```
Location: users/business_1234567890/cards/-NxYz123
Read: โ Allowed (ุฅุฐุง ูุงู UID ูุทุงุจู)
Read: โ Denied (ุฅุฐุง ูุงู UID ูุฎุชูู)
```

---

## โ๏ธ ููุงุญุธุงุช ูููุฉ

### 1. ุงูููุงุนุฏ ุงูุญุงููุฉ (ูุจู ุงูุชุญุฏูุซ)

ุฅุฐุง ูุงูุช ููุงุนุฏู ุงูุญุงููุฉ:

```json
{
  "rules": {
    ".read": true,
    ".write": true
  }
}
```

**โ๏ธ ุฎุทุฑ!** ูุฐุง ูุนูู:
- โ ุฃู ุดุฎุต ููููู ูุฑุงุกุฉ ุฌููุน ุงูุจูุงูุงุช
- โ ุฃู ุดุฎุต ููููู ูุชุงุจุฉ/ุญุฐู ุฃู ุจูุงูุงุช
- โ ูุง ุญูุงูุฉ ุนูู ุงูุฅุทูุงู

**ุงูุญู**: ุงุณุชุจุฏููุง ุจุงูููุงุนุฏ ุงูุฌุฏูุฏุฉ ููุฑุงู!

---

### 2. ุงูุฃุฎุทุงุก ุงูุดุงุฆุนุฉ

#### ุฎุทุฃ 1: Permission Denied

```
Error: PERMISSION_DENIED: Permission denied
```

**ุงูุณุจุจ**:
- ุงููุณุชุฎุฏู ูุง ูููู ุตูุงุญูุฉ ุงููุตูู
- UID ุบูุฑ ูุทุงุจู
- ูู ูุชู ุชุณุฌูู ุงูุฏุฎูู

**ุงูุญู**:
```javascript
// ุชุฃูุฏ ูู ุชุณุฌูู ุงูุฏุฎูู
if (!user?.uid) {
  console.log('โ ุงููุณุชุฎุฏู ุบูุฑ ูุณุฌู ุฏุฎูู');
  return;
}

// ุชุฃูุฏ ูู ุงุณุชุฎุฏุงู UID ุงูุตุญูุญ
await saveCard(user.uid, cardData); // โ
await saveCard('wrong_uid', cardData); // โ
```

---

#### ุฎุทุฃ 2: Validation Failed

```
Error: VALIDATION_FAILED: Data validation failed
```

**ุงูุณุจุจ**:
- ุงูุจูุงูุงุช ูุง ุชุทุงุจู ุงูููุงุนุฏ
- ุญูู ูุทููุจ ูุงูุต
- ูููุฉ ุบูุฑ ุตุญูุญุฉ

**ุงูุญู**:
```javascript
// ุชุญูู ูู ุงูุจูุงูุงุช ูุจู ุงูุฅุฑุณุงู
const cardData = {
  cardNumber: "9012",           // โ 4 ุฃุญุฑู
  bankName: "ูุตุฑู ุงูุฑุงุฌุญู",     // โ ููุฌูุฏ
  cardType: "mada",              // โ ูููุฉ ุตุญูุญุฉ
  expiryDate: "12/25",           // โ ุตูุบุฉ ุตุญูุญุฉ
  // ... ุจููุฉ ุงูุญููู ุงููุทููุจุฉ
};
```

---

### 3. ุงุฎุชุจุงุฑ ุงูููุงุนุฏ ูู Development

ูุจู ุงููุดุฑ ุนูู Productionุ ุงุฎุชุจุฑ ุงูููุงุนุฏ:

```javascript
// Test 1: ุญูุธ ุจุทุงูุฉ
try {
  const result = await saveCard(user.uid, validCardData);
  console.log('โ Test passed:', result);
} catch (error) {
  console.log('โ Test failed:', error.message);
}

// Test 2: ูุฑุงุกุฉ ุจุทุงูุงุช
try {
  const result = await getUserCards(user.uid);
  console.log('โ Test passed:', result);
} catch (error) {
  console.log('โ Test failed:', error.message);
}

// Test 3: ุญุฐู ุจุทุงูุฉ
try {
  const result = await deleteCard(user.uid, cardId);
  console.log('โ Test passed:', result);
} catch (error) {
  console.log('โ Test failed:', error.message);
}
```

---

## ๐ ููุงุฑูุฉ ูุจู/ุจุนุฏ

### ูุจู ุชุทุจูู ุงูููุงุนุฏ โ

```json
{
  "rules": {
    ".read": true,
    ".write": true
  }
}
```

- โ ุฃู ุดุฎุต ููุฑุฃ ุฌููุน ุงูุจุทุงูุงุช
- โ ุฃู ุดุฎุต ูุญุฐู ุฃู ุจุทุงูุฉ
- โ ูููู ุญูุธ ุฑูู ุงูุจุทุงูุฉ ุงููุงูู
- โ ูููู ุญูุธ CVV
- โ ูุง ุชุญูู ูู ุงูุจูุงูุงุช

---

### ุจุนุฏ ุชุทุจูู ุงูููุงุนุฏ โ

```json
{
  "rules": {
    "users": {
      "$uid": {
        "cards": {
          ".read": "auth != null && auth.uid == $uid",
          ".write": "auth != null && auth.uid == $uid"
        }
      }
    }
  }
}
```

- โ ุงููุณุชุฎุฏู ููุฑุฃ ุจุทุงูุงุชู ููุท
- โ ุงููุณุชุฎุฏู ูุญุฐู ุจุทุงูุงุชู ููุท
- โ ุฑูู ุงูุจุทุงูุฉ 4 ุฃุฑูุงู ููุท
- โ CVV ููููุน ุชูุงูุงู
- โ ุชุญูู ูุงูู ูู ุงูุจูุงูุงุช

---

## ๐ ุงูุฎุทูุงุช ุงูุชุงููุฉ

1. **ูุดุฑ ุงูููุงุนุฏ**:
   - ูุณุฎ ุงูููุงุนุฏ ูู `firebase-rules.json`
   - ูุดุฑูุง ูู Firebase Console

2. **ุงุฎุชุจุงุฑ**:
   - ุงุฎุชุจุงุฑ ุญูุธ ุจุทุงูุฉ
   - ุงุฎุชุจุงุฑ ูุฑุงุกุฉ ุจุทุงูุงุช
   - ุงุฎุชุจุงุฑ ุญุฐู ุจุทุงูุฉ
   - ุงุฎุชุจุงุฑ ุงูุตูุงุญูุงุช

3. **ูุฑุงูุจุฉ**:
   - ูุฑุงูุจุฉ Logs ูู Firebase Console
   - ุงูุชุญูู ูู ุฃุฎุทุงุก PERMISSION_DENIED
   - ุงูุชุญูู ูู ุฃุฎุทุงุก VALIDATION_FAILED

4. **ุชูุซูู**:
   - ุชูุซูู ุฃู ุชุบููุฑุงุช ุนูู ุงูููุงุนุฏ
   - ุญูุธ ูุณุฎุฉ ุงุญุชูุงุทูุฉ ูู ุงูููุงุนุฏ

---

## ๐ ุงูุฏุนู

ุฅุฐุง ูุงุฌูุช ูุดุงูู:

1. ุฑุงุฌุน [Firebase Documentation](https://firebase.google.com/docs/database/security)
2. ุชุญูู ูู Console Logs
3. ุงุณุชุฎุฏู Firebase Simulator
4. ุฑุงุฌุน ูุฐุง ุงูููู

---

**ุชุงุฑูุฎ ุงูุฅูุดุงุก**: 2024-12-06
**ุงูุฅุตุฏุงุฑ**: 1.0.0
**ุงูุญุงูุฉ**: โ ุฌุงูุฒ ููุชุทุจูู

**ุงูููุงุนุฏ ูุญุฏุซุฉ ูุขููุฉ!** ๐
